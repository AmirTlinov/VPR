# Требования безопасности VPR VPN

**Версия:** 1.0  
**Дата:** 2024-12-19  
**Статус:** КРИТИЧНО

---

## КРИТИЧЕСКИЕ ТРЕБОВАНИЯ

### CRIT-001: Заменить небезопасную генерацию случайных чисел

**Аномалии, требующие исправления:**
- `src/masque-core/src/bin/vpn_server.rs:231` — `generate_session_id()` использует `rand::random()` (thread RNG), что даёт предсказуемые session_id.
- `src/vpr-crypto/src/noise.rs:27` — статический X25519 секрет формируется через `rand::thread_rng().fill_bytes`.
- `src/vpr-crypto/src/noise.rs:380,393,398` — тестовые/эфемерные ключи в Noise handshake также получают энтропию через `thread_rng`.

**Требование:**
- Во всех перечисленных местах подключить `rand::rngs::OsRng` и использовать его для заполнения секретного материала.
- Добавить юнит‑тест, проверяющий, что вызовы `generate_session_id()` и `HybridKeypair::generate()` используют `OsRng` (можно замокать RNG).

**Критерий приемки:** Поиск по коду не содержит `thread_rng()` и `rand::random()` вне тестовых заглушек; новые тесты подтверждают использование `OsRng`.

---

### CRIT-002: Добавить очистку ML-KEM секретов

**Файл:** `src/vpr-crypto/src/noise.rs:70-74`

**Требование:**
- Добавить явную очистку `mlkem_secret` в `Drop` для `HybridKeypair`
- Использовать `zeroize` или `unsafe` для очистки памяти ML-KEM секрета
- Проверить API `pqcrypto-mlkem` на возможность безопасной очистки

**Критерий приемки:** Все секретные ключи очищаются при drop

---

### CRIT-003: Защитить сервер от повторного воспроизведения рукопожатий

**Наблюдение:** Библиотека `snow` закрывает криптографические replay-атаки, однако `HybridServer::handshake_ik()` ( `src/masque-core/src/hybrid_handshake.rs` ) принимает соединение независимо от частоты запросов. Злоумышленник может многократно инициировать IK, удерживая ресурсы сервера.

**Требование:**
- Добавить модуль `replay_protection` с учётом временного окна (например, 5 минут).
- Сохранять отпечаток (hash) первых сообщений Noise/гибридного public bundle и отбрасывать повтор за окно.
- Экспортировать счётчик отклонённых рукопожатий, чтобы метрики фиксировали DoS.

**Критерий приемки:** Повтор IK/NK с теми же параметрами в пределах окна приводит к немедленному отказу, что подтверждается интеграционным тестом.

---

### CRIT-004: Исправить обработку ошибок

**Файл:** `src/masque-core/src/bin/vpn_server.rs:391-393`

**Требование:**
- Заменить `expect()` на `?` с `context()` в извлечении `client_pubkey`
- Убрать все `expect()` из критических путей
- Добавить валидацию размера `hybrid_secret.combined` перед извлечением

**Критерий приемки:** Нет `expect()` в критических путях

---

### CRIT-005: Внедрить полноценный парсинг IP пакетов в `tun_reader_task`

**Наблюдение:** В `tun_reader_task` (`src/masque-core/src/bin/vpn_server.rs:541-562`) используются первые 20 байт пакета без валидации версии и длины, несмотря на наличие готового парсера `IpPacketInfo::parse()` (`src/masque-core/src/tun.rs:217-245`).

**Требование:**
- Вызвать `IpPacketInfo::parse()` для каждого пакета, чтобы автоматически проверялись версия, длина и заголовок.
- Использовать `IpPacketInfo::dst_addr` вместо прямого чтения `packet[16..20]`.
- При ошибке парсинга логировать `warn!(reason)` и отбрасывать пакет.

**Критерий приемки:** Интеграционный тест с повреждённым заголовком приводит к предупреждению и отсутствию паники; кода с прямым обращением к `packet[16]` не остаётся.

---

### CRIT-006: Реализовать TLS fingerprint obfuscation

**Требование:**
- Интегрировать библиотеку uTLS/uConfig или аналог
- Создать модуль `src/masque-core/src/tls_fp.rs`
- Реализовать профили fingerprint (Chrome, Firefox, Safari)
- Реализовать механизм `tls-fp-sync` для автообновления профилей
- Добавить канареечную проверку перед применением новых профилей
- Интегрировать с QUIC клиентом и сервером

**Критерий приемки:** TLS fingerprint обфусцирован, JA3 уникальность <0.2%

---

### CRIT-007: Реализовать адаптивный padding

**Требование:**
- Создать модуль `src/masque-core/src/padding.rs`
- Реализовать padding buckets: 32, 64, 256, 1024 bytes
- Добавить DPI feedback loop для выбора bucket
- Интегрировать с packet encapsulation
- Реализовать timing obfuscation (jittered pacing)

**Критерий приемки:** Padding применяется адаптивно, suspicion score <0.35

---

### CRIT-008: Реализовать cover traffic

**Требование:**
- Создать модуль `src/masque-core/src/cover_traffic.rs`
- Реализовать trace-driven pattern engine
- Поддержать HTTPS/HTTP3/WebRTC patterns
- Интегрировать с основным туннелем
- Настроить интенсивность cover traffic

**Критерий приемки:** Cover traffic работает, patterns соответствуют реальному трафику

---

### CRIT-009: Реализовать защиту от активных зондов

**Требование:**
- Создать модуль `src/masque-core/src/probe_protection.rs`
- Реализовать challenge/response с PQ токенами
- Добавить проверку padding schedule
- Реализовать drop при неудачной проверке
- Добавить логирование подозрительных запросов

**Критерий приемки:** Активные зонды обнаруживаются и блокируются

---

### CRIT-010: Реализовать автоматическую ротацию ключей

**Требование:**
- Реализовать отслеживание времени и объема трафика для session tickets
- Автоматически вызывать `rekey()` каждые 60 секунд или 1 ГБ
- Реализовать ротацию Noise seeds каждые 14 дней
- Реализовать ротацию TLS сертификатов каждые 6 часов через ACME
- Обновлять ключи без разрыва соединений

**Критерий приемки:** Все ключи ротируются автоматически согласно требованиям

---

## ВЫСОКИЙ ПРИОРИТЕТ

### HIGH-001: Зафиксировать constant-time поведение криптографических примитивов

**Наблюдение:** Библиотека `snow` должна обеспечивать constant-time реализацию, однако в репозитории отсутствует проверка или документированное подтверждение этого факта.

**Требование:**
- Добавить тест/скрипт, фиксирующий использованные версии `snow`, `chacha20poly1305`, `aes-gcm` и ссылку на их аудиты.
- Если где-либо выполняются сравнения буферов самостоятельно, обернуть их в `subtle::ConstantTimeEq`.
- В `docs/security.md` описать политику проверки constant-time поведения при обновлении зависимостей.

**Критерий приемки:** В репозитории есть автоматизированная проверка или документ, подтверждающий constant-time свойства используемых библиотек; пользовательский код не содержит прямых сравнений секретов.

---

### HIGH-002: Улучшить проверку прав для DNS protection

**Файл:** `src/masque-core/src/tun.rs:387-411`

**Требование:**
- Добавить проверку прав доступа перед записью в `/etc/resolv.conf`
- Проверять, что процесс имеет root права или файл принадлежит root
- Возвращать ошибку, если прав недостаточно

**Критерий приемки:** DNS protection проверяет права доступа

---

### HIGH-003: Сделать DNS серверы конфигурируемыми

**Файл:** `src/masque-core/src/bin/vpn_server.rs:417-418`

**Требование:**
- Добавить параметр `--dns-servers` с разделителем запятая
- Парсить список DNS серверов из параметра
- Использовать конфигурируемые DNS серверы вместо хардкода

**Критерий приемки:** DNS серверы настраиваются через параметры

---

### HIGH-004: Реализовать подписанный bootstrap manifest

**Требование:**
- Создать формат bootstrap manifest
- Реализовать подпись manifest через Ed25519
- Реализовать валидацию подписи на клиенте
- Публиковать manifest через ODoH/DoH
- Реализовать версионирование manifest
- Реализовать откат на cached версию при подмене

**Критерий приемки:** Bootstrap manifest подписан и валидируется

---

### HIGH-005: Реализовать WebRTC fallback

**Требование:**
- Интегрировать WebRTC библиотеку
- Реализовать ephemeral browser relays
- Реализовать broker для выбора peers с низким suspicion score
- Использовать как fallback при недоступности MASQUE

**Критерий приемки:** WebRTC fallback работает при недоступности основного пути

---

### HIGH-006: Реализовать domain fronting

**Требование:**
- Реализовать механизм domain fronting для MASQUE
- Поддержать несколько front доменов
- Реализовать ротацию front доменов
- Интегрировать с bootstrap manifest

**Критерий приемки:** Domain fronting работает, домены ротируются

---

## СРЕДНИЙ ПРИОРИТЕТ

### MED-001: Улучшить логирование

**Требование:**
- Убрать логирование секретов (даже частично)
- Добавить структурированное логирование с `tracing::instrument`
- Добавить логирование в критических путях handshake
- Настроить уровни логирования

**Критерий приемки:** Логирование структурировано, секреты не логируются

---

### MED-002: Реализовать suspicion score

**Требование:**
- Создать модуль `src/masque-core/src/suspicion.rs`
- Реализовать алгоритм расчета suspicion score
- Собирать метрики: DNS failures, QUIC resets, JA3 блокировки
- Экспортировать score в Prometheus/OpenTelemetry
- Интегрировать с GUI

**Критерий приемки:** Suspicion score рассчитывается и экспортируется, <0.35

---

### MED-003: Реализовать JA3/JA4 tracking

**Требование:**
- Реализовать сбор TLS fingerprint
- Рассчитывать уникальность JA3/JA4
- Экспортировать метрики
- Интегрировать с мониторингом

**Критерий приемки:** JA3/JA4 отслеживаются, уникальность <0.2%

---

### MED-004: Реализовать мониторинг DNS

**Требование:**
- Отслеживать DNS failure rate
- Отслеживать NXDOMAIN spikes
- Отслеживать SERVFAIL
- Экспортировать метрики

**Критерий приемки:** DNS метрики собираются, failure rate <1%

---

### MED-005: Реализовать session tracking

**Требование:**
- Отслеживать время жизни сессий
- Отслеживать объем трафика на сессию
- Рассчитывать session survival rate (24h)
- Экспортировать метрики

**Критерий приемки:** Session tracking работает, survival rate ≥99.95%

---

## ТЕСТИРОВАНИЕ

### TEST-001: Настроить fuzzing

**Требование:**
- Добавить `cargo-fuzz` в dev-dependencies
- Создать fuzz targets для handshake сообщений
- Создать fuzz targets для IP пакетов
- Создать fuzz targets для DNS запросов
- Интегрировать в CI/CD

**Критерий приемки:** Fuzzing настроен, не находит критических багов

---

### TEST-002: Реализовать chaos testing

**Требование:**
- Создать сценарии packet loss
- Создать сценарии connection drops
- Создать сценарии network partitions
- Автоматизировать запуск chaos тестов

**Критерий приемки:** Chaos тесты проходят, система устойчива

---

### TEST-003: Настроить DPI тестирование

**Требование:**
- Настроить DPI эмулятор
- Создать тестовые сценарии
- Проверить обфускацию TLS fingerprint
- Проверить адаптивный padding
- Проверить cover traffic

**Критерий приемки:** DPI тесты показывают низкий suspicion score

---

### TEST-004: Реализовать side-channel тестирование

**Требование:**
- Реализовать timing attack тесты
- Проверить constant-time операции
- Проверить защиту от cache attacks

**Критерий приемки:** Side-channel тесты проходят

---

## ДОКУМЕНТАЦИЯ

### DOC-001: Обновить документацию безопасности

**Требование:**
- Создать `docs/security.md` с описанием механизмов безопасности
- Обновить `README.md` с текущим состоянием
- Документировать процесс ротации ключей
- Документировать процесс обновления TLS fingerprint

**Критерий приемки:** Документация актуальна и полна

---

### DOC-002: Документировать API

**Требование:**
- Добавить документацию для всех публичных API
- Документировать криптографические протоколы
- Документировать форматы сообщений

**Критерий приемки:** Все публичные API документированы

---

## ЗАВИСИМОСТИ

### DEPS-001: Провести аудит зависимостей

**Требование:**
- Проверить все зависимости на CVE
- Обновить уязвимые зависимости
- Задокументировать процесс обновления зависимостей

**Критерий приемки:** Нет известных уязвимостей в зависимостях

---

## ИНФРАСТРУКТУРА

### INFRA-001: Проверить безопасность конфигураций

**Требование:**
- Проверить безопасность Terraform конфигураций
- Проверить безопасность Ansible playbooks
- Валидировать входные данные в конфигах
- Проверить скрипты развертывания

**Критерий приемки:** Конфигурации безопасны, валидация работает

---

## МЕТРИКИ УСПЕХА

### Метрики безопасности
- Suspicion score <0.35
- JA3 уникальность <0.2%
- DNS failure rate <1%
- Session survival ≥99.95% (24h)

### Метрики производительности
- Throughput ≥800 Мбит/с (базовая)
- Latency overhead <70ms
- CPU usage <70%

### Метрики надежности
- Bootstrap время <3s
- Автоматическая ротация ключей работает
- Все тесты проходят

---

## ПРИОРИТЕТЫ ВНЕДРЕНИЯ

1. **Неделя 1-2:** CRIT-001, CRIT-002, CRIT-003, CRIT-004, CRIT-005
2. **Неделя 3-6:** CRIT-006, CRIT-007, CRIT-008, CRIT-009
3. **Неделя 7-9:** CRIT-010, HIGH-001, HIGH-002, HIGH-003
4. **Неделя 10-11:** HIGH-004, HIGH-005, HIGH-006, MED-001, MED-002
5. **Неделя 12-13:** MED-003, MED-004, MED-005, TEST-001, TEST-002
6. **Неделя 14-15:** TEST-003, TEST-004, DOC-001, DOC-002, DEPS-001, INFRA-001

---

**Статус:** Все требования обязательны к выполнению перед production deployment.

