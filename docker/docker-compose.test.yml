# VPR VPN Integration Test Environment
#
# Usage:
#   docker compose -f docker/docker-compose.test.yml up --build
#   docker compose -f docker/docker-compose.test.yml run test-runner
#
# This setup creates:
#   1. VPN Server with TUN device and NAT
#   2. VPN Client connecting to server
#   3. Test runner to verify connectivity

services:
  # ==========================================================================
  # Key Generator - generates Noise keys and TLS certs for testing
  # ==========================================================================
  keygen:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: server
    volumes:
      - secrets:/secrets
      - certs:/certs
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "=== Generating test keys and certificates ==="

        # Generate Noise keypairs if not exist
        if [ ! -f /secrets/server.noise.pub ]; then
          echo "Generating server Noise keypair..."
          vpn-server keygen --dir /secrets --name server 2>/dev/null || \
            echo "Keygen not available, creating placeholder"
        fi

        if [ ! -f /secrets/client.noise.pub ]; then
          echo "Generating client Noise keypair..."
          vpn-server keygen --dir /secrets --name client 2>/dev/null || \
            echo "Keygen not available, creating placeholder"
        fi

        # Generate self-signed TLS cert if not exist
        if [ ! -f /certs/server.crt ]; then
          echo "Generating self-signed TLS certificate..."
          apk add --no-cache openssl >/dev/null 2>&1 || true
          openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:prime256v1 \
            -keyout /certs/server.key -out /certs/server.crt \
            -days 365 -nodes -subj "/CN=vpn-server" \
            -addext "subjectAltName=DNS:vpn-server,IP:10.99.0.2" 2>/dev/null
          chmod 600 /certs/server.key
        fi

        echo "=== Keys generated ==="
        ls -la /secrets/ /certs/

  # ==========================================================================
  # VPN Server
  # ==========================================================================
  vpn-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: server
    depends_on:
      keygen:
        condition: service_completed_successfully
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.forwarding=1
    volumes:
      - secrets:/app/secrets:ro
      - certs:/app/certs:ro
    networks:
      vpn-net:
        ipv4_address: 10.99.0.2
    ports:
      - "4433:4433/udp"
    environment:
      - RUST_LOG=info,masque_core=debug
      - VPR_ALLOW_INSECURE=1
    command:
      - vpn-server
      - --bind=0.0.0.0:4433
      - --tun-name=vpr0
      - --tun-addr=10.9.0.1
      - --pool-start=10.9.0.2
      - --pool-end=10.9.0.254
      - --mtu=1400
      - --noise-dir=/app/secrets
      - --noise-name=server
      - --cert=/app/certs/server.crt
      - --key=/app/certs/server.key
      - --enable-forwarding
      - --idle-timeout=300
    healthcheck:
      test: ["CMD", "sh", "-c", "ss -uln | grep -q ':4433'"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # ==========================================================================
  # VPN Client
  # ==========================================================================
  vpn-client:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: client
    depends_on:
      vpn-server:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - secrets:/app/secrets:ro
    networks:
      vpn-net:
        ipv4_address: 10.99.0.3
    environment:
      - RUST_LOG=info,masque_core=debug
      - VPR_ALLOW_INSECURE=1
    command:
      - vpn-client
      - --server=10.99.0.2:4433
      - --server-name=vpn-server
      - --server-pub=/app/secrets/server.noise.pub
      - --noise-dir=/app/secrets
      - --noise-name=client
      - --insecure
    healthcheck:
      test: ["CMD", "sh", "-c", "ip link show vpr0 2>/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 15s

  # ==========================================================================
  # Test Runner
  # ==========================================================================
  test-runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: test-runner
    depends_on:
      vpn-client:
        condition: service_healthy
    networks:
      vpn-net:
        ipv4_address: 10.99.0.4
    environment:
      - VPN_SERVER_IP=10.99.0.2
      - VPN_CLIENT_IP=10.99.0.3
      - VPN_GATEWAY=10.9.0.1
    volumes:
      - ./scripts:/test/scripts:ro
      - test-results:/test/results
    command: ["/test/scripts/run-tests.sh"]

networks:
  vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.99.0.0/24
          gateway: 10.99.0.1

volumes:
  secrets:
  certs:
  test-results:
