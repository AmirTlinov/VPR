# –ê—É–¥–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ MASQUE CONNECT-UDP

**–î–∞—Ç–∞:** 2025-01-27  
**–ê—É–¥–∏—Ç–æ—Ä:** AI Security Auditor  
**–í–µ—Ä—Å–∏—è:** 1.1  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-27 - –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

## –†–µ–∑—é–º–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è MASQUE CONNECT-UDP —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç RFC 9298 –∏ RFC 9297. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 8.5/10

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 1
### –í—ã—Å–æ–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 2
### –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 3
### –ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: 2

---

## 1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º (RFC 9298, RFC 9297)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ RFC 9298 (CONNECT-UDP)

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Extended CONNECT —Å `:protocol: connect-udp`
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URI template: `/.well-known/masque/udp/{host}/{port}/`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–≤–µ—Ç–∞: `capsule-protocol: ?1`
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ QUIC datagrams –¥–ª—è UDP payload
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä UDP payload: 65,527 –±–∞–π—Ç (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç RFC)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ RFC 9297 (Capsule Protocol)

- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ capsule:
  - UDP (Context ID 0)
  - Handshake (Context ID 1)
  - Address Request (Context ID 2)
  - Address Assign (Context ID 3)
  - Close (Context ID 4)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ varint –¥–ª—è context ID
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç length-prefixed capsules

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

- ‚ö†Ô∏è **Address Request/Assign capsules –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã** (—Ç–æ–ª—å–∫–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É Address Request/Assign –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö UDP targets

---

## 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: Unsafe –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ h3

**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:303-357`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```rust
unsafe {
    // –î–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ RequestStream —á–µ—Ä–µ–∑ transmutation
    let stream_ptr = &stream as *const h3::server::RequestStream<...>;
    // ... unsafe pointer arithmetic
}
```

**–†–∏—Å–∫–∏:**
1. **Undefined Behavior** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã h3/h3-quinn
2. **Memory safety violations** –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π
3. **Fragile code** - –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å `#[allow(unsafe_code)]` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –æ —Ä–∏—Å–∫–∞—Ö
2. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π API h3, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:** –°–æ–∑–¥–∞—Ç—å issue/PR –≤ h3 –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```rust
// SAFETY: This unsafe block performs layout transmutation to access the inner
// BidiStream from RequestStream. This is fragile to changes in h3/h3-quinn internal
// structure. See: https://github.com/hyperium/h3/issues/XXX
#[allow(unsafe_code)]
unsafe {
    // ... existing code
}
```

### ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è target

- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ localhost, loopback, private ranges
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ multicast, broadcast, unspecified IPs
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Ä—Ç–∞ (–Ω–µ 0)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ hostname –Ω–∞ localhost variants

**–£–ª—É—á—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- –î–æ–±–∞–≤–∏—Ç—å whitelist/blacklist –¥–ª—è target validation

### ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `Result<T>`
- ‚úÖ –ù–µ—Ç –ø–∞–Ω–∏–∫ –≤ production –∫–æ–¥–µ (—Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–∞—Ö)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ CapsuleBuffer

**–§–∞–π–ª:** `src/masque-core/src/masque.rs:440-507`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `CapsuleBuffer` –º–æ–∂–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö capsule
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ length prefix

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```rust
const MAX_BUFFER_SIZE: usize = 128 * 1024; // 128KB max buffer

pub fn add_bytes(&mut self, data: Bytes) -> Result<Option<UdpCapsule>> {
    if self.buf.len() + data.len() > MAX_BUFFER_SIZE {
        bail!("buffer size exceeded: {} > {}", self.buf.len() + data.len(), MAX_BUFFER_SIZE);
    }
    // ... rest of code
}
```

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ capsule –ø–µ—Ä–µ–¥ –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ MAX_CAPSULE_SIZE = 65536 –±–∞–π—Ç
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è UDP payload size (MAX_UDP_PAYLOAD = 65,527)

---

## 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- ‚úÖ –ë–∞—Ç—á–∏–Ω–≥ UDP datagrams —á–µ—Ä–µ–∑ `UdpForwardingBuffer`
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Bytes` –¥–ª—è zero-copy
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `BytesMut` –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 1. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π lock –Ω–∞ NoiseTransport

**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:418-432`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```rust
match t.lock() {
    Ok(mut transport) => {
        // –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –¥–µ—Ä–∂–∏—Ç lock
    }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `try_lock()` —Å fallback –Ω–∞ –æ—á–µ—Ä–µ–¥—å
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è encryption/decryption

#### 2. –ù–µ—Ç connection pooling –¥–ª—è UDP sockets

**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:375-383`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞–∂–¥—ã–π CONNECT-UDP —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π UDP socket
- –ù–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å connection pool –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö targets
- –î–æ–±–∞–≤–∏—Ç—å keep-alive –¥–ª—è UDP connections

#### 3. –ù–µ—Ç backpressure –¥–ª—è datagrams

**–ü—Ä–æ–±–ª–µ–º–∞:**
- QUIC datagrams –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å flow control –¥–ª—è datagram –æ—Ç–ø—Ä–∞–≤–∫–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞

---

## 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ edge cases

### ‚úÖ –•–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ truncated varint
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ oversized capsules
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö capsule –≤ –±—É—Ñ–µ—Ä–µ
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö encryption

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

#### 1. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ Close capsule

**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:442-450`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```rust
} else if capsule.is_handshake() {
    debug!("Received handshake capsule in datagram forwarding");
    // Handshake capsules should be handled before forwarding starts
} else {
    debug!(context_id = capsule.context_id, "ignoring unknown context ID");
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```rust
} else if capsule.is_close() {
    info!("Received Close capsule, shutting down forwarding");
    break; // Gracefully shutdown
} else if capsule.is_handshake() {
    // ...
}
```

#### 2. –ù–µ—Ç timeout –¥–ª—è UDP forwarding

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π loop –±–µ–∑ timeout –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Ç–µ—á–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```rust
use tokio::time::{timeout, Duration};

loop {
    match timeout(Duration::from_secs(300), conn_clone.read_datagram()).await {
        Ok(Ok(datagram)) => { /* ... */ }
        Ok(Err(_)) => break,
        Err(_) => {
            warn!("UDP forwarding timeout, closing connection");
            break;
        }
    }
}
```

#### 3. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö capsule –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è capsule, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å cleanup –¥–ª—è `CapsuleBuffer` –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

---

## 5. –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

### ‚úÖ –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

- ‚úÖ Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ Integration —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è edge cases (oversized capsules, truncated data)

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

#### 1. –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è unsafe –±–ª–æ–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ unsafe –¥–æ—Å—Ç—É–ø–∞
- –î–æ–±–∞–≤–∏—Ç—å fuzzing —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è memory safety issues

#### 2. –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Close capsule handling

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –¥–ª—è graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ Close capsule

#### 3. –ù–µ—Ç property-based —Ç–µ—Å—Ç–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `proptest` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å roundtrip –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ capsule

---

## 6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### ‚úÖ –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö API
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö

### ‚ö†Ô∏è –£–ª—É—á—à–µ–Ω–∏—è

#### 1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è unsafe –±–ª–æ–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ safety invariants
- –£–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ issue/PR –¥–ª—è –∑–∞–º–µ–Ω—ã unsafe –∫–æ–¥–∞

#### 2. –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å benchmarks
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–µ–º—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

---

## 7. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º VPR

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

- ‚úÖ –ù–µ—Ç `unwrap()` –≤ production –∫–æ–¥–µ
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `Result`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `anyhow::Result` –¥–ª—è error handling
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `tracing`

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

#### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `expect()` –≤ CapsuleBuffer

**–§–∞–π–ª:** `src/masque-core/src/masque.rs:487`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```rust
let expected = self.expecting_len.expect(
    "expecting_len should be Some after reading length prefix - this indicates a logic bug",
);
```

**–û—Ü–µ–Ω–∫–∞:** ‚úÖ –ü—Ä–∏–µ–º–ª–µ–º–æ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏
- –°–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
- –ù–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å unsafe –±–ª–æ–∫** (–¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã)
2. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É Close capsule** –¥–ª—è graceful shutdown
3. **–î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è UDP forwarding**

### üü° –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

4. **–î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞** –≤ CapsuleBuffer
5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É Address Request/Assign capsules**
6. **–î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è target validation**

### üü¢ –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

7. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å lock –Ω–∞ NoiseTransport** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try_lock)
8. **–î–æ–±–∞–≤–∏—Ç—å connection pooling** –¥–ª—è UDP sockets
9. **–î–æ–±–∞–≤–∏—Ç—å backpressure** –¥–ª—è datagram –æ—Ç–ø—Ä–∞–≤–∫–∏

### üîµ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

10. **–£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** –¥–ª—è unsafe –±–ª–æ–∫–∞
11. **–î–æ–±–∞–≤–∏—Ç—å benchmarks** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
12. **–†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ** (property-based —Ç–µ—Å—Ç—ã)

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è MASQUE CONNECT-UDP –≤ —Ü–µ–ª–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:

1. **Unsafe –∫–æ–¥–æ–º** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ h3 (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ Close capsule** (–ª–µ–≥–∫–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º timeout** –¥–ª—è UDP forwarding (–ª–µ–≥–∫–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

---

## –ß–µ–∫–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- [x] ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è unsafe –±–ª–æ–∫–∞ (–¥–æ–±–∞–≤–ª–µ–Ω `#[allow(unsafe_code)]` –∏ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
- [x] ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É Close capsule (–¥–æ–±–∞–≤–ª–µ–Ω graceful shutdown)
- [x] ‚úÖ –î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è UDP forwarding (5 –º–∏–Ω—É—Ç timeout)
- [x] ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ –≤ CapsuleBuffer (128KB max, –∑–∞—â–∏—Ç–∞ –æ—Ç DoS)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è Close capsule handling
- [ ] –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è target validation
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã unsafe –±–ª–æ–∫—É (—Ç—Ä–µ–±—É–µ—Ç upstream –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ h3)

## –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ Close capsule ‚úÖ
**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:442-444`
```rust
} else if capsule.is_close() {
    info!("Received Close capsule, shutting down UDP forwarding gracefully");
    break; // Gracefully shutdown forwarding
}
```

### 2. Timeout –¥–ª—è UDP forwarding ‚úÖ
**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:414-479`
- –î–æ–±–∞–≤–ª–µ–Ω timeout 5 –º–∏–Ω—É—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è datagrams
- Graceful shutdown –ø—Ä–∏ timeout
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ ‚úÖ
**–§–∞–π–ª:** `src/masque-core/src/masque.rs:440-484`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `max_buffer_size` (128KB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç memory exhaustion –∞—Ç–∞–∫

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è unsafe –±–ª–æ–∫–∞ ‚úÖ
**–§–∞–π–ª:** `src/masque-core/src/h3_server.rs:306`
- –î–æ–±–∞–≤–ª–µ–Ω `#[allow(unsafe_code)]` —Å —è–≤–Ω—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
- –î–æ–±–∞–≤–ª–µ–Ω TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–º–µ–Ω—ã
- –£–ª—É—á—à–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è safety invariants
