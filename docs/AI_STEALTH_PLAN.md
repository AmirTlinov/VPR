# План интеграции компактной ИИ-модели (≤50 млн параметров) в VPR

## 1. Цели
- Снизить suspicion score и JA3 уникальность за счёт динамического управления маскировкой.
- Автоматически выбирать TLS профили, padding, cover traffic и fallback маршруты на основе телеметрии.
- Реагировать на DPI/цензурные атаки быстрее человека.
- Обеспечить прозрачные объяснения решений для оператора.

## 2. Роль ИИ
ИИ выступает как **Stealth Orchestrator**:
- Анализирует окна телеметрии (RTT, packet loss, suspicion, DPI verdict).
- Прогнозирует риск блокировки и рекомендует действия:
  - выбор `TlsProfile`, ECH/ECH-off, порядок cipher suites;
  - настройка `Padder` (bucket, стратегия, jitter);
  - выбор паттерна `CoverTrafficGenerator`;
  - переключение маршрутов (MASQUE front, DoH/ODoH, WebRTC fallback).
- Ведёт “канареечные” раскатки (5% клиентов) и собирает обратную связь.

## 3. Данные
1. **Телеметрия туннеля:** RTT, jitter, throughput, error rate, suspicion score, JA3 уникальность.
2. **События DPI/блокировок:** QUIC reset, TLS alert, probe detection.
3. **Логи cover traffic, padding, TLS профилей.**
4. **Исторические решения операторов** (ручные переключения) — teacher forcing.
5. **Synthetic DPI сценарии** из тестового стенда (health-harness, DPI симулятор).

Хранение: централизованный time-series (Parquet + MinIO) + Kafka для стримов. Анонимизация обязательна.

## 4. Архитектура модели
- Тип: компактный Transformer/TCN (например, 4 encoder блока, hidden 512, ~40 млн параметров в FP16).
- Вход: окно из N=32 таймстемпов, каждый содержит ~64 признака (metriks, one-hot транспортов, флаги).
- Выходы:
  1. Вероятность блока в ближайшие 30 секунд.
  2. Вектор действий (softmax) по `TlsProfile`, `PaddingStrategy`, `CoverPattern`, `Route`.
  3. Уверенность (для канареечного контроля).
- Loss: смесь BCE (риск), cross-entropy (действия), KL-регуляризация против baseline политики.

## 5. Pipeline обучения
1. Сбор и очистка данных (daily ETL).
2. Feature engineering ( стандартизация метрик, one-hot протоколов, rolling stats).
3. Train/val split по времени (последний месяц — валидация).
4. Обучение в PyTorch → экспорт в ONNX (<200 МБ).
5. Метрики: AUC по предсказанию блоков, uplift по suspicion score в off-line симуляциях.
6. Месячный retrain + контроль дрейфа данных.

## 6. Инференс и интеграция
- Сервис `ai_orchestrator` (Rust + ONNX Runtime/TensorRT).
- Инпут: батчи телеметрии из NATS/Kafka (каждые 2–5 секунд).
- Output: JSON с рекомендациями + confidence.
- `control-plane` применяет решения через API:
  - обновляет `TlsProfile` клиента/сервера;
  - задаёт параметры `Padder` и `CoverTrafficGenerator`;
  - инициирует `ProbeProtector`/`replay_protection` включение;
  - переключает bootstrap маршруты.
- Канареечный режим: 5% клиентов следуют советам, сравниваем с контрольной группой.
- Логи решений и метрики в Prometheus/Grafana.

## 7. Расширенные (экспериментальные) ИИ-модули
Ниже перечислены инженерные идеи, которые можно реализовать после базового Stealth Orchestrator.

1. **Neural Traffic Doppelgänger**  
   - Тренируем автоэнкодеры на реальном HTTPS/HTTP3 трафике CDN;  
   - Выход автоэнкодера задаёт таргет для `Padder` + `CoverTrafficGenerator`, чтобы туннель был неотличим от настоящих flows.

2. **Adaptive MASQUE Morphing**  
   - Микросервис, который по решениям модели меняет поведение MASQUE (порядок кадров, вставка пустых datagram, смена MTU), имитируя разные сайты.

3. **AI-guided multi-path tunneling**  
   - Контроллер распределяет трафик между MASQUE front, DoH/ODoH и WebRTC на основе вероятности блока;  
   - Использует softmax над “маршрутами” + ограничения по QoS.

4. **Probe Persona Engine**  
   - Генератор “персон” для ответов активным зондами (разные JA3, тайминги);  
   - Облегчает `ProbeProtector`, выдавая заранее выбранные сценарии поведения.

5. **RL-драйвер cover traffic**  
   - Используем reinforcement learning (PPO/TD3) с reward = f(suspicion, throughput);  
   - Агент управляет параметрами cover traffic и padding в реальном времени.

6. **Generative bootstrap disguise**  
   - Sequence-to-sequence модель, которая встраивает bootstrap manifest в разные носители (RSS, git diff, EXIF) по команде.

7. **Predictive censor tracking**  
   - Graph/temporal модель прогнозирует, где и когда появится блокировка, чтобы заранее раскатить обновления fingerprint-ов или маршрутов.

8. **Self-healing orchestration**  
   - ИИ наблюдает за Terraform/Ansible, TLS/ECH, DNS; при сбоях автоматически запускает сценарии `Rotate Fronts`, перевыпуск сертификатов, откат конфигов.

9. **Adversarial DPI training**  
   - Локальный DPI-симулятор + генеративная модель, которая учится находить против него “уязвимые” паттерны и переносить их в прод.

10. **Explainable Stealth HUD**  
    - Надстройка, показывающая оператору причины решений (важность признаков, прогноз риска), позволяя быстро доверять или отклонять рекомендации.

## 7. Безопасность и объяснимость
- Решения ИИ — “soft recommendations”; финальные правила проверяют допустимость (например, не отключать encryption).
- Логи с причинно-следственными пояснениями (какие признаки привели к решению).
- Возможность ручного override и мгновенного отката.
- Проверка на “mode collapse”: алерты, если модель навязывает один профиль >80% времени.

## 8. Дорожная карта
1. **Неделя 1:** собрать минимальный датасет, определить признаки, подготовить ETL.
2. **Неделя 2:** baseline модель (простая MLP) для оценки влияния.
3. **Неделя 3–4:** основной Transformer/TCN, off-line симуляции с DPI стендом.
4. **Неделя 5:** внедрить `ai_orchestrator` сервис, канареечный rollout.
5. **Неделя 6+:** расширить action space (маршруты, cover-traffic), добавить RL компонент для cover traffic.

## 9. KPI
- Снижение suspicion score < 0.25 (сейчас <0.35).
- Уменьшение доли блоков/ resets >30%.
- Среднее время восстановления соединения <5 секунд.
- Рост throughput ≥10% за счёт адаптивного padding.
- ≥90% решений сопровождаются понятным объяснением.

Этот план позволяет внедрить мелкую (≤50M) модель как интеллектуальный слой управления маскировкой, не перепроектируя криптоядро, но резко повышая адаптивность VPN.

