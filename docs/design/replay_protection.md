# ADR: Replay Protection Window (CRIT-003)

## Контекст
- Угрозы: повтор начальных сообщений рукопожатия для перепривязки IP/ключей или DoS.
- Требования: окно 5 минут, дрейф часов до 60с не влияет, O(1) вставка/проверка, метрики отказов.

## Решение
- Ключ: SHA-256 по первым 128 байтам сообщения, берём 16 байт префикса.
- Хранилище: `HashMap<[u8;16], Instant>` под `RwLock`, TTL = 300s, периодичная очистка каждые 60s.
- Вставка/проверка: `check_and_record` — O(1) ожидаемо, двойная проверка под read→write.
- Метрики: `ReplayMetrics` + экспорт в Prometheus текст `to_prometheus(prefix)`, tracing события `telemetry.replay` (blocked/processed).
- Стагнация: `is_stale()` для манифеста оставляет 24h окно на кэш (другая подсистема) — совместимо.

## Альтернативы
- ЛРУ/Counting Bloom — отвергнуто: повышенная вероятность ложных отказов, сложнее доказать отсутствие флапов.
- Lock-free map — усложняет код; текущая нагрузка не обосновывает.

## Влияние на ресурсы
- Память: ~32 байта на запись (ключ+Instant+overhead). При 10k одновременных рукопожатиях ≈ 320 KB.
- Время: O(1) операции; cleanup раз в 60s, проход по карте.

## Тесты/валидаторы
- unit: `test_expired_message_accepted_again`, `test_hash_uses_prefix`.
- integration: `replay_window_enforced` (ускоренный TTL) проверяет окно и метрику отказов.
- lint: markdownlint.

## Мониторинг
- Экспорт `replay_messages_processed`, `replay_replays_blocked`, `replay_entries_expired`.
- Tracing события `telemetry.replay` для быстрой диагностики.

## Риски
- Большие сообщения с одинаковым префиксом — намеренный компромисс ради O(1).
- Увеличение окна без пересчёта TTL может удерживать память дольше; покрыто алертом на рост map size (требуется подключить в telemetry).
