# VPR Automated E2E Testing

Автоматизированное end-to-end тестирование VPN с полной автоматизацией установки и настройки.

## Описание

Скрипт `e2e_automated.sh` имитирует пользовательский опыт работы с VPN:
- **Кнопка 1**: Автоматическая установка и настройка VPN сервера
- **Кнопка 2**: Автоматическое подключение клиента и тестирование

## Требования

### Локальная машина (клиент)
- Root привилегии
- `sshpass`, `cargo`, `ip`, `ping`, `curl`
- Собранные бинарники: `vpn-client`, `vpn-server`, `vpr-keygen`

### Удаленный сервер
- SSH доступ с root правами
- Ubuntu/Debian система
- Минимум 500MB свободного места (для установки Rust и зависимостей)

## Использование

```bash
# Базовое использование
sudo ./scripts/e2e_automated.sh --server 64.176.70.203 --password 'PASSWORD'

# С указанием пользователя
sudo ./scripts/e2e_automated.sh --server 64.176.70.203 --user root --password 'PASSWORD'
```

## Что делает скрипт

### Фаза 1: Установка сервера (Button 1)

1. **Проверка зависимостей**
   - Проверяет наличие необходимых инструментов локально

2. **Установка зависимостей на сервере**
   - Устанавливает Rust (если не установлен)
   - Устанавливает системные пакеты (build-essential, openssl, iptables и т.д.)

3. **Сборка и загрузка бинарников**
   - Собирает `vpn-server` и `vpr-keygen` локально
   - Загружает их на сервер в `/opt/vpr/bin/`

4. **Генерация ключей**
   - Генерирует Noise ключи сервера
   - Генерирует TLS сертификат
   - Скачивает публичный ключ сервера для клиента

5. **Настройка сети**
   - Включает IP forwarding
   - Настраивает firewall правила

6. **Запуск сервера**
   - Запускает VPN сервер в фоновом режиме
   - Проверяет, что сервер успешно запустился

### Фаза 2: Подключение клиента (Button 2)

1. **Сборка клиента**
   - Собирает `vpn-client` локально (если еще не собран)

2. **Генерация ключей клиента**
   - Генерирует Noise ключи клиента

3. **Подключение к VPN**
   - Запускает VPN клиент
   - Ожидает создания TUN устройства
   - Настраивает маршрутизацию и DNS

4. **Тестирование**
   - Ping gateway
   - Проверка маршрутизации
   - Тест DNS разрешения
   - Тест внешней связности
   - Тест HTTP подключения

5. **Генерация отчета**
   - Создает подробный отчет о тестировании

## Структура логов

Все логи сохраняются в `logs/e2e_automated/`:
- `test.log` - основной лог выполнения
- `client.log` - логи VPN клиента
- `ping_gateway.log` - результаты ping тестов
- `dns_test.log` - результаты DNS тестов
- `external_ip.log` - внешний IP через VPN
- `http_test.log` - результаты HTTP тестов
- `test_report_*.txt` - подробные отчеты

## Настройка сервера

После выполнения скрипта на сервере будет:

```
/opt/vpr/
├── bin/
│   ├── vpn-server      # VPN сервер
│   └── vpr-keygen      # Утилита генерации ключей
├── secrets/
│   ├── server.noise.key    # Приватный Noise ключ
│   ├── server.noise.pub    # Публичный Noise ключ
│   ├── server.crt          # TLS сертификат
│   └── server.key          # TLS приватный ключ
└── logs/
    └── server.log          # Логи сервера
```

## Очистка

Скрипт автоматически очищает:
- Локальные TUN устройства при завершении
- Восстанавливает оригинальную маршрутизацию
- Восстанавливает оригинальные DNS настройки

Для очистки сервера используйте:
```bash
sshpass -p 'PASSWORD' ssh root@SERVER_IP 'pkill -9 vpn-server; ip link del vpr-srv; rm -rf /opt/vpr'
```

## Устранение неполадок

### Сервер не запускается
- Проверьте логи: `ssh root@SERVER_IP 'cat /opt/vpr/logs/server.log'`
- Убедитесь, что порт 4433 свободен
- Проверьте права на файлы ключей

### Клиент не подключается
- Проверьте логи клиента: `cat logs/e2e_automated/client.log`
- Убедитесь, что сервер запущен: `ssh root@SERVER_IP 'pgrep -f vpn-server'`
- Проверьте firewall на сервере

### TUN устройство не создается
- Убедитесь, что запущено с root правами
- Проверьте, что модуль TUN загружен: `lsmod | grep tun`
- Проверьте логи клиента на ошибки

## Примеры использования

### Полный тест с очисткой
```bash
# Очистка сервера перед тестом
sshpass -p 'PASSWORD' ssh root@SERVER_IP 'pkill -9 vpn-server; ip link del vpr-srv 2>/dev/null || true'

# Запуск теста
sudo ./scripts/e2e_automated.sh --server SERVER_IP --password 'PASSWORD'
```

### Тест только подключения (если сервер уже установлен)
```bash
# Пропустить установку можно, модифицировав скрипт или используя e2e_simple_test.sh
sudo ./scripts/e2e_simple_test.sh --server SERVER_IP --password 'PASSWORD'
```

## Примечания

- Скрипт требует root привилегии для создания TUN устройств и настройки маршрутизации
- Первый запуск может занять время из-за установки Rust и сборки бинарников
- Все пароли передаются через командную строку (небезопасно для продакшена)
- Для продакшена рекомендуется использовать SSH ключи вместо паролей
